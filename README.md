# Интеграционный сервис для синхронизации запчастей (n8n + PostgreSQL)

## Группа 8

Это небольшое интеграционное приложение, которое забирает данные о запчастях из CMS, сохраняет всю историю изменений в PostgreSQL и периодически отправляет свежий CSV-отчёт в Report API. Всё сделано на **n8n**.

---

## Что делает система

Есть два основных процесса:

1. **Синхронизация: CMS -> PostgreSQL**

   Забираем все детали с сервера, сравниваем с тем, что уже есть, и обновляем базу.

3. **Экспорт отчёта: PostgreSQL -> Report API**

   Берём актуальные записи, собираем CSV вручную и отправляем его в API.

---

## Как устроена база

Используется одна таблица `lab_spares_archive`.
В ней хранится **вся история**, но у каждой детали есть флаг `is_active`, который показывает, какая версия сейчас актуальна.

Если данные поменялись - старая версия выключается (`is_active=false`), создаётся новая.
Если деталь исчезает из CMS - мы её тоже деактивируем.

---

## Workflow 1 - Synchronization CMS to DB

Файл: **1. Synchronization CMS to DB.json**

### Что он делает:

1. **Качает все страницы CMS**

   Там есть пагинация, поэтому в кодовом узле стоит цикл `while`, который скачивает данные, пока CMS что-то отдаёт.

3. **Приводит данные в порядок**
   - исправляет формат цены,
   - чистит дату,
   - подготавливает поля для базы.

4. **Обновляет базу**

   Для каждой детали:
   - если новой записи нет - вставляет,
   - если есть и данные изменились - старую выключает, вставляет новую,
   - если всё совпадает - ничего не делает.

6. **Архивирует отсутствующие детали**

   Система выявляет детали, которые были удалены из CMS. Если какая-то запчасть не пришла от CMS в текущей выгрузке, она помечается в базе как `is_active = FALSE`.

---

## Workflow 2 - Export DB to Report API

Файл: **2. Export DB to Report API.json**

### Что он делает:

1. **Выбирает последнюю версию каждой детали**

   Использует SQL-конструкцию `DISTINCT ON (spare_code)` с сортировкой по дате `valid_from DESC`.

   Это позволяет включить в отчет абсолютно все детали, которые когда-либо были в системе, но в их самом свежем состоянии.

3. **Генерирует CSV вручную**

   Вручную, потому что стандартный CSV-узел n8n добавляет BOM, а Report API этого не принимает.

   Скрипт делает всё очень просто:

   - соединяет значения через `;`,
   - формирует файл как текст,
   - превращает его в Base64 для отправки.

5. **Отправляет CSV в Report API**
